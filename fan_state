#!/usr/bin/env bash

set -euo pipefail

check_debugfs() {
    if ! grep -q "debugfs" /proc/mounts; then
        echo "Error: debugfs not mounted. Please mount it with:"
        echo "  sudo mount -t debugfs none /sys/kernel/debug"
        echo "Or add to /etc/fstab: debugfs /sys/kernel/debug debugfs mode=0755 0 0"
        exit 1
    fi

    if [ ! -d /sys/kernel/debug/asus-nb-wmi ]; then
        echo "Error: /sys/kernel/debug/asus-nb-wmi not found."
        echo "Make sure the asus-nb-wmi module is loaded, and that the asus-fan-permissions service is loaded and running."
        exit 1
    fi

    if [ ! -w /sys/kernel/debug/asus-nb-wmi/dev_id ]; then
        echo "Error: No write permission to /sys/kernel/debug/asus-nb-wmi/"
        echo "Please run the systemd service to set permissions:"
        echo "  sudo systemctl start asus-fan-permissions.service"
        exit 1
    fi
}

get_reg_no() {
    local model
    model=$(cat /sys/class/dmi/id/product_name 2>/dev/null | tr -d '\n' | xargs)
    if [[ $model =~ Vivobook\ S\ 15\ S5506 ]]; then
        echo "0x5002f"
    elif [[ $model =~ Zenbook\ S\ 16\ UM5606 ]] || [[ $model =~ Vivobook\ M5606 ]] || [[ $model =~ Zenbook\ S\ 14\ UX5406SA ]]; then
        echo "0x110019"
    else
        echo "0x110019"
    fi
}

set_fan_state() {
    check_debugfs

    local state_value

    case $1 in
        0|standard)
            state_value=0
            ;;
        1|quiet)
            state_value=1
            ;;
        2|high)
            state_value=2
            ;;
        3|full)
            state_value=3
            ;;
        *)
            echo "Error: Invalid fan state. Use 0-3 or standard/quiet/high/full."
            exit 1
            ;;
    esac

    echo "Setting fan state to $state_value"
    
    cd /sys/kernel/debug/asus-nb-wmi
    echo $(get_reg_no) > dev_id
    echo $state_value > ctrl_param
    cat devs
    
    if [[ -n "$XDG_RUNTIME_DIR" ]]; then
        echo "$state_value" > "$XDG_RUNTIME_DIR/fan_state"
    fi
    
    if command -v dbus-send >/dev/null 2>&1; then
        if [[ $EUID -eq 0 ]] && [[ -z "$DBUS_SESSION_BUS_ADDRESS" ]]; then
            if [[ -n "$SUDO_UID" ]]; then
                export DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$SUDO_UID/bus"
            fi
        fi
    
        if [[ -n "$DBUS_SESSION_BUS_ADDRESS" ]]; then
            dbus-send --session \
            --dest=dev.t1c.FanState \
            --type=signal \
            /dev/t1c/FanState \
            dev.t1c.FanState.StateSet \
            int32:$state_value 2>/dev/null || true
        fi
    fi
}

get_fan_state() {
    check_debugfs

    cd /sys/kernel/debug/asus-nb-wmi
    echo $(get_reg_no) > dev_id
    state=$(cat ctrl_param)

    local state_value
    local state_name

    case $state in
        0x00000000)
        	state_value=0
        	state_name="standard"
            ;;
        0x00000001)
            state_value=1
            state_name="quiet"
            ;;
        0x00000002)
            state_value=2
            state_name="high"
            ;;
        0x00000003)
            state_value=3
            state_name="full"
            ;;
        *)
            state_value="${state}"
            state_name="unknown"
            ;;
    esac

    echo "${state_name} (${state_value})"
}

help_msg() {
    echo "Usage:"
    echo "  fan_state set <0-3|standard|quiet|high|full> - Set the fan state."
    echo "  fan_state get - Get the current fan state."
    echo "  fan_state get-int - Get the current fan state as an integer."
}

if [ $# -eq 0 ]; then
    help_msg
    exit 1
fi

case $1 in
    set|-s|--set)
        if [ $# -ne 2 ]; then
            echo "Error: 'set' command requires an argument (0-3 or standard/quiet/high/full)."
            exit 1
        fi
        set_fan_state $2
        ;;
    get|-g|--get)
        get_fan_state
        ;;
    get-int|--get-int)
        res="$(get_fan_state)"
        echo "${res//[^0-9]/}"
        ;;
    help|--help|-h)
        help_msg
        ;;
    *)
        help_msg
        exit 1
        ;;
esac

exit
